# 課題報告書：Unity Catalog (Azure Databricks) と AWS S3 の認証方式不整合

## 1. 概要
Azure Databricks の Unity Catalog から AWS S3 を外部ロケーションとして登録際、設計段階で想定していた「IAM User (Access Key/Secret Key)」による認証が使用できず、「IAM Role」による認証への設計変更・手戻りが発生した。

## 2. 発生事象
- **工程**: 環境構築 (Unity Catalog セットアップ)
- **事象**: Databricks UI の「Storage Credential (ストレージ資格情報)」作成画面において、AWS S3 へのアクセス権として **「IAM Role (ARN)」しか選択できず、用意していた「IAM User Access Key」を入力できなかった**。
- **影響**: 作業停止、設計変更 (CloudFormation)、ノートブック修正。

## 3. 分析
### 直接原因
設計書に「IAM User Access Key (AWS Secrets Manager)」を使用すると規定されていたが、**Azure Databricks Unity Catalog for AWS S3** はこの認証方式をサポートしていなかった。

### なぜ起きたか (Why)
- **AWS Databricks** では Access Key による認証が可能であり、その知識をそのまま Azure Databricks に適用してしまっていた。
- Unity Catalog (セキュリティガバナンス機能) の仕様確認不足。Unity Catalog はセキュリティ強化のため、永続的なアクセスキーの使用を制限し、IAM Role (AssumeRole) による一時的な認証トークンを強制している。

### 真因 (Root Cause)
**マルチクラウド構成特有の「相互接続仕様」に対する調査・検証不足**
- 「Databricks から S3 につながる」という大枠の仕様確認のみで、「Azure Databricks から AWS S3 へのクロスアカウント・クロスプラットフォーム接続」という特殊性 (AssumeRole必須) を認識できていなかった。
- 設計段階での PoC (実機検証) が行われておらず、机上の汎用的な知識のみで詳細設計を進めてしまった。

## 4. 対応処置
1. **CloudFormation 修正**: Azure Databricks アカウントからの `sts:AssumeRole` を許可する IAM Role を追加 (信頼ポリシー: Azure Databricks サービスプリンシパル + External ID)。
2. **構成変更**: 認証方式を IAM User → IAM Role に変更し、セキュリティ強度を向上 (永続的なキーから一時的なトークンへ)。
3. **ドキュメント反映**: 設計書 (システム構成図)、CloudFormationテンプレート、Setupノートブックを実態に合わせて修正完了。

## 5. 再発防止策
- **クロスプラットフォーム仕様の重点確認**: 異なるクラウド間 (Azure ↔ AWS) で連携する場合、汎用的な仕様ではなく「相互接続における制約」を重点的に公式ドキュメントで確認する。
- **重要な接続部分の先行検証**: 認証・ネットワークなど、失敗した場合の影響が大きい部分は、詳細設計前に簡単な疎通確認 (PoC) を行うプロセスを組み込む。

#アナロジー
そのイメージ、**完璧**です！とてもセンスの良い例えですね。

その例えを使って、今回の「なぜ怒られた（エラーになった）のか」を整理すると、さらに分かりやすくなります。

### 1. IAMユーザー（パスワード付きPPT）

* **あなたのイメージ:** 「パスワードを知っていれば誰でも開ける」
* **今回の状況:**
* あなたはAWS（S3）というPPTにパスワード（アクセスキー）を設定しました。
* そしてAzure Databricksに「はい、これがパスワードだから、これをメモしておいて毎回入力してね」と渡そうとしました。
* **Azure Databricksの言い分:** 「えっ、そんな重要なパスワードを預かりたくないよ！ 万が一、僕がそのメモを落としたらどうするの？ 責任取れないよ！」（＝セキュリティリスクが高いから非対応）



### 2. IAMロール（課長レイヤー限定PPT）

* **あなたのイメージ:** 「『課長』という役職（立場）の人なら見ていいよ（人事DBで身元確認）」
* **今回の正解:**
* AWS（S3）というPPTに、「『Azure Databricks』という身分証明書を持ってる人なら、中身を見せていいよ」というルール（IAMロール）を作りました。
* Azure Databricksは、アクセスするたびに「僕はAzure Databricksです（身分証明提示）」とAWSに伝えます。
* AWSは「確認できた。じゃあ今だけ使える閲覧カードを渡すね」と通します。
* **Azure Databricksの言い分:** 「これなら僕がパスワードを管理しなくていいし、必要な時だけ許可をもらう形だから安心だね！」
---

### まとめ
おっしゃる通り、
* **IAMユーザー** ＝ 「鍵（パスワード）」そのものを渡してしまうやり方
* **IAMロール** ＝ 「その人（システム）の立場」を信頼して、都度許可を与えるやり方

今回は、Azure Databricksというシステムが**「鍵を預かるのは怖いから、立場（ロール）で判断してくれ」**と言った、という理解で間違いありません。
その感覚でいけば、今後のAWS学習もスムーズに進むと思います！