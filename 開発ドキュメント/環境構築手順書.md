# 環境構築手順書

## 1. 概要

本書はNorthwindデータレイクハウスの環境構築手順を記載します。

---

## 2. 前提条件

| 項目 | 要件 |
|------|------|
| Azureサブスクリプション | 有効なサブスクリプション |
| AWSアカウント | RDS作成済み |
| Databricks | Premium以上（Unity Catalog利用のため） |

---

## 3. AWS環境構築

### 3.1 CloudFormationスタック作成

```bash
# 開発ドキュメント/cloudformation-premigration.yaml を使用
aws cloudformation create-stack \
  --stack-name northwind-premigration \
  --template-body file://cloudformation-premigration.yaml \
  --capabilities CAPABILITY_NAMED_IAM
```

### 3.2 作成されるリソース

| リソース | 説明 |
|---------|------|
| VPC | 10.0.0.0/16 |
| Public Subnet | RDS配置用 |
| RDS PostgreSQL | Northwindデータベース |
| Security Group | Inbound 5432 |

---

## 4. Azure環境構築

### 4.1 リソース作成順序

1. リソースグループ
2. ストレージアカウント（ADLS Gen2）
3. Access Connector for Azure Databricks
4. ロール割り当て

### 4.2 詳細手順

→ `azure-adls-setup-guide.md` を参照

---

## 5. Databricks設定

### 5.1 Unity Catalog設定

```sql
-- カタログ作成
CREATE CATALOG IF NOT EXISTS northwind_catalog;

-- スキーマ作成
CREATE SCHEMA IF NOT EXISTS northwind_catalog.bronze;
CREATE SCHEMA IF NOT EXISTS northwind_catalog.silver;
CREATE SCHEMA IF NOT EXISTS northwind_catalog.gold;
```

### 5.2 Storage Credential作成

```sql
CREATE STORAGE CREDENTIAL azure_adls_credential
WITH (
  AZURE_MANAGED_IDENTITY_ACCESS_CONNECTOR_ID = '<Access Connector リソースID>'
);
```

### 5.3 External Location作成

```sql
CREATE EXTERNAL LOCATION ext_bronze
URL 'abfss://bronze@<storage-account>.dfs.core.windows.net/'
WITH (STORAGE CREDENTIAL azure_adls_credential);
```

---

## 6. Secrets設定

### 6.1 Secret Scope作成

Databricks CLI または UI で作成：
- Scope名: `northwind-secrets`

### 6.2 シークレット登録

| Key | 説明 |
|-----|------|
| rds-host | RDSエンドポイント |
| rds-user | DBユーザー名 |
| rds-password | DBパスワード |

---

## 変更履歴

| 日付 | 変更内容 |
|------|----------|
| 2026-02-09 | 初版作成 |
