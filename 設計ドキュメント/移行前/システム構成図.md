# ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³ï¼ˆç§»è¡Œå‰ï¼šAzure Databricks + Azure ADLSï¼‰

ã“ã®ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ ã¯ã€Œ**æš«å®šæ§‹æˆ: DatabricksãŒAzureä¸Šã«ã‚ã‚Šã€Azure Data Lake Storage (ADLS Gen2) ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹å ´åˆ**ã€ã‚’ç¤ºã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

- **Databricks**: Azure Databricksï¼ˆæœ‰æ–™ç‰ˆï¼‰- Unity Catalog ä½¿ç”¨å¯èƒ½
- **RDS**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã®AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã«å­˜åœ¨ï¼ˆã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯**: Azure Data Lake Storage Gen2ï¼ˆBronze/Silver/Goldï¼‰
- **æ¥ç¶š**: 
  - Databricks â†” ADLS: Azureå†…éƒ¨é€šä¿¡ï¼ˆManaged Identityï¼‰
  - Databricks â†” AWS RDS: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ï¼ˆJDBCï¼‰

## ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹

- é€šå¸¸è¡¨è¨˜: è¨˜è¼‰æ¸ˆã¿
- `ï¼ˆğŸ“æš—é»™ï¼‰`: å­˜åœ¨ãŒå‰æã ãŒè©³ç´°ã¯çœç•¥
- `ï¼ˆğŸ”§è©³ç´°è¨­è¨ˆï¼‰`: è©³ç´°è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã§è¿½åŠ äºˆå®š
- `ï¼ˆâ›”ä¸è¦ï¼‰`: ä»Šå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ä½¿ç”¨ã—ãªã„

```mermaid
flowchart TB
  %% ============================
  %% Azure Environment
  %% ============================
  subgraph Azure["Azure ç’°å¢ƒ"]
    subgraph AzureDatabricks["Azure Databricks"]
      DBXControl["Databricks Control Plane<br/>(SaaS)"]
      DBXCompute["Databricks Compute<br/>(Azure VMã‚¯ãƒ©ã‚¹ã‚¿)"]
      UnityCatalog[("Unity Catalog<br/>(ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿/ãƒªãƒãƒ¼ã‚¸/ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡)")]
      DBXSecrets["Databricks Secrets<br/>(èªè¨¼æƒ…å ±ç®¡ç†)"]
      DBXControl --> DBXCompute
      DBXCompute --> UnityCatalog
    end
    
    subgraph AzureStorage["Azure Storage"]
      ADLS[("Azure Data Lake Storage Gen2<br/>lake-northwind/<br/>(Delta Lake)")]
      ADLSBronze["bronze/"]
      ADLSSilver["silver/"]
      ADLSGold["gold/"]
      ADLS --- ADLSBronze
      ADLS --- ADLSSilver
      ADLS --- ADLSGold
    end
    
    subgraph AzureIdentity["Azure Identity"]
      AccessConnector["Access Connector<br/>for Azure Databricks"]
      ManagedIdentity["Managed Identity<br/>(Storage Blob Data Contributor)"]
      AccessConnector --> ManagedIdentity
    end
    
    %% Azureå†…éƒ¨æ¥ç¶š
    DBXCompute -->|"Managed Identity<br/>(abfss://)"| ADLS
    ManagedIdentity -.->|"èªè¨¼"| ADLS
    UnityCatalog -->|"å¤–éƒ¨ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³"| ADLS
  end

  %% ============================
  %% AWS Account (RDS Only)
  %% ============================
  subgraph AWS["AWS Account / Region: ap-southeast-2"]
    
    subgraph VPC["VPC (10.0.0.0/16)"]
      IGW["IGW<br/>ï¼ˆğŸ“æš—é»™ï¼‰"]
      
      subgraph PublicSubnet["Public Subnet<br/>(10.0.0.0/24)"]
        RDS[("RDS PostgreSQL<br/>(Northwind)<br/>ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹æœ‰åŠ¹")]
      end
      
      SGrds["SG: rds<br/>(Inbound: 5432 from Azure IP)"]
    end

    Secrets[("AWS Secrets Manager<br/>(DBæ¥ç¶šæƒ…å ±)")]
    
    %% --- ä»Šå›ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ ---
    subgraph NotUsed["ä»Šå›ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ï¼ˆâ›”ï¼‰"]
      S3["S3 Bucket<br/>ï¼ˆâ›”ADLSã«å¤‰æ›´ï¼‰"]
      IAMRole["IAM Role<br/>ï¼ˆâ›”ADLSã«å¤‰æ›´ï¼‰"]
      IAMUser["IAM User<br/>ï¼ˆâ›”ä¸è¦ï¼‰"]
    end

  end

  %% ============================
  %% ã‚¯ãƒ­ã‚¹ã‚¯ãƒ©ã‚¦ãƒ‰æ¥ç¶š
  %% ============================
  Internet((("ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ")))

  DBXCompute -->|"JDBC over TLS<br/>(Port 5432)"| Internet
  Internet -->|"ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPçµŒç”±"| RDS
  RDS --- SGrds
  IGW -.-> Internet
  
  DBXSecrets -.->|"DBèªè¨¼æƒ…å ±"| DBXCompute
```

## æ§‹æˆè¦ç´ ä¸€è¦§

| ã‚«ãƒ†ã‚´ãƒª | è¦ç´  | èª¬æ˜ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|---------|------|------|------------|
| **Azure Databricks** | Control Plane | SaaSã®ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ« | âœ… |
| | Compute | Azure VMãƒ™ãƒ¼ã‚¹ã®Sparkã‚¯ãƒ©ã‚¹ã‚¿ | âœ… |
| | Unity Catalog | ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿/ãƒªãƒãƒ¼ã‚¸/ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | âœ… |
| | Databricks Secrets | èªè¨¼æƒ…å ±ã®å®‰å…¨ãªç®¡ç† | âœ… |
| **Azure Storage** | ADLS Gen2 | ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ï¼ˆDelta Lakeå½¢å¼ã§ä¿å­˜ï¼‰ | âœ… |
| | bronze/ | å—é ˜ãƒ‡ãƒ¼ã‚¿ï¼ˆRawï¼‰ | âœ… |
| | silver/ | ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ | âœ… |
| | gold/ | é›†è¨ˆãƒ»åˆ†æç”¨ãƒ‡ãƒ¼ | âœ… |
| **Azure Identity** | Access Connector | Databricksã¨ADLSã‚’æ¥ç¶š | âœ… |
| | Managed Identity | ADLSã¸ã®èªè¨¼ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ¬ã‚¹ï¼‰ | âœ… |
| **AWSãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** | VPC | RDSã‚’é…ç½®ã™ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | âœ… |
| | Public Subnet | RDSã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«é…ç½® | âœ… |
| | Security Groups | Azure Databricksã®IPã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯ | âœ… |
| | IGW | VPCã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã¸ã®å‡ºå£ | ğŸ“æš—é»™ |
| **AWSã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆ** | RDS PostgreSQL | ã‚½ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆNorthwindï¼‰ | âœ… |
| **AWSã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | AWS Secrets Manager | DBæ¥ç¶šæƒ…å ±ã®å®‰å…¨ãªç®¡ç† | âœ… |
| **ä»Šå›ä¸è¦** | S3 | ADLSã«å¤‰æ›´ã—ãŸãŸã‚ | â›”ä¸è¦ |
| | IAM Role/User | ADLSã«å¤‰æ›´ã—ãŸãŸã‚ | â›”ä¸è¦ |

---

## æ¥ç¶šæ–¹æ³•ã®è©³ç´°

### 1. RDS ã¸ã®æ¥ç¶šï¼ˆAWS â†’ Azure Databricksï¼‰

| é …ç›® | è¨­å®š |
|------|------|
| **RDS ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹** | æœ‰åŠ¹ (Publicly Accessible = Yes) |
| **Security Group** | Inbound: TCP 5432 ã‚’ Azure Databricks ã® IP ç¯„å›²ã‹ã‚‰è¨±å¯ |
| **SSL/TLS** | å¿…é ˆ (`sslmode=require`) |
| **æ¥ç¶šæ–‡å­—åˆ—ä¾‹** | `jdbc:postgresql://<RDS-endpoint>:5432/northwind?sslmode=require` |

> [!WARNING]
> ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚IPåˆ¶é™ + SSL ã‚’å¿…ãšè¨­å®šã—ã¦ãã ã•ã„ã€‚
> æœ¬ç•ªç’°å¢ƒã§ã¯ PrivateLink ã¾ãŸã¯ VPN ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

### 2. ADLS ã¸ã®æ¥ç¶šï¼ˆAzure Databricks â†’ ADLS Gen2ï¼‰

| é …ç›® | è¨­å®š |
|------|------|
| **èªè¨¼æ–¹å¼** | Managed Identityï¼ˆAccess Connector for Azure Databricksï¼‰ |
| **æ¨©é™** | Storage Blob Data Contributor ãƒ­ãƒ¼ãƒ« |
| **Databricksè¨­å®š** | Unity Catalog Storage Credential ã« Access Connector ã®ãƒªã‚½ãƒ¼ã‚¹ID ã‚’ç™»éŒ² |
| **ãƒ‘ã‚¹å½¢å¼** | `abfss://<container>@<storage-account>.dfs.core.windows.net/` |

### 3. Unity Catalog ã®è¨­å®š

| é …ç›® | è¨­å®š |
|------|------|
| **ãƒ¡ã‚¿ã‚¹ãƒˆã‚¢** | Azure Databricks ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ç´ã¥ã‘ |
| **å¤–éƒ¨ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³** | ADLS Gen2 ã‚’å¤–éƒ¨ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ç™»éŒ² |
| **Storage Credential** | Access Connector for Azure Databricksï¼ˆManaged Identityï¼‰ |

## ç§»è¡Œå¾Œã¨ã®å·®åˆ†

| é …ç›® | ç§»è¡Œå‰ï¼ˆæš«å®šãƒ»æœ¬æ§‹æˆï¼‰ | ç§»è¡Œå¾Œï¼ˆæœ€çµ‚ï¼‰ |
|------|------------------------|----------------|
| Databricksç’°å¢ƒ | Azure Databricks | AWS Databricksï¼ˆåŒä¸€VPCï¼‰ |
| ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ | Azure ADLS Gen2 | AWS S3ï¼ˆåŒä¸€VPCï¼‰ |
| RDSã‚¢ã‚¯ã‚»ã‚¹ | ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP + SGåˆ¶é™ | Private Subnet + VPCå†…é€šä¿¡ |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èªè¨¼ | Managed Identity | IAM Role (Instance Profile) |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | ä¸­ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±ï¼‰ | é«˜ï¼ˆVPCå†…å®Œçµï¼‰ |
| Unity Catalog | âœ… ä½¿ç”¨å¯èƒ½ | âœ… ä½¿ç”¨å¯èƒ½ |

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ |
|------|-----------|----------|
| 2024-02-08 | v2.0 | ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ã‚¯ã‚’AWS S3ã‹ã‚‰Azure ADLS Gen2ã«å¤‰æ›´ |
| | | Azure Databricksã®åˆ¶ç´„ï¼ˆIAM Roleèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ã«å¯¾å¿œ |
