# システム構成図（物理・ネットワーク）

このダイアグラムは「**どこに何があるか**」を示す物理的な構成図です。

```mermaid
flowchart TB
  %% ============================
  %% Databricks Control Plane (SaaS)
  %% ============================
  ControlPlane["Databricks Control Plane<br/>(SaaS - Databricks管理)"]

  subgraph AWS["AWS Account / Region: ap-northeast-1"]
    
    %% --- VPC ---
    subgraph VPC["VPC (10.0.0.0/16)"]
      
      subgraph PrivateSubnet["Private Subnet<br/>(10.0.1.0/24)"]
        DBXCompute["Databricks Compute<br/>(EC2 クラスタ)"]
        RDS[("RDS PostgreSQL<br/>(Northwind)")]
      end

      subgraph PublicSubnet["Public Subnet<br/>(10.0.0.0/24)"]
        NAT["NAT Gateway<br/>(インターネット接続用)"]
      end

      %% Security Groups
      SGdbx["SG: dbx-compute<br/>(Outbound: All)"]
      SGrds["SG: rds<br/>(Inbound: 5432 from dbx-compute)"]
      
    end

    %% --- VPC外のAWSサービス ---
    S3[("S3 Bucket<br/>s3://lake-northwind/<br/>(Delta Lake)")]
    IAMRole["IAM Role<br/>(Instance Profile)<br/>S3 Read/Write権限"]
    Secrets[("AWS Secrets Manager<br/>or Databricks Secret Scope<br/>(DB接続情報)")]
    CloudWatch[("CloudWatch<br/>(ログ/アラート)")]
    SNS["SNS<br/>(通知: ジョブ失敗時)"]

  end

  %% ============================
  %% 接続線
  %% ============================
  
  %% Control Plane → Compute
  ControlPlane -->|"クラスタ管理"| DBXCompute
  
  %% Compute ↔ RDS
  DBXCompute --- SGdbx
  RDS --- SGrds
  DBXCompute -->|"TCP 5432<br/>(JDBC)"| RDS

  %% Compute → S3
  DBXCompute -->|"S3 API<br/>(HTTPS)"| S3
  
  %% IAM / Secrets
  DBXCompute -.->|"AssumeRole"| IAMRole
  IAMRole -.->|"権限付与"| S3
  DBXCompute -.->|"シークレット取得"| Secrets

  %% Monitoring
  DBXCompute -.->|"ログ送信"| CloudWatch
  CloudWatch -.->|"アラート発火"| SNS

  %% NAT (Internet)
  DBXCompute -.->|"外部通信"| NAT
```

## 構成要素一覧

| カテゴリ | 要素 | 説明 |
|---------|------|------|
| **ネットワーク** | VPC | Databricks ComputeとRDSを同一VPCに配置 |
| | Private Subnet | RDSとComputeを配置（インターネット非公開） |
| | Public Subnet | NAT Gateway経由で外部通信 |
| | Security Groups | RDSへのアクセスをCompute IPのみに制限 |
| **コンピュート** | Databricks Compute | EC2ベースのSparkクラスタ |
| | RDS PostgreSQL | ソースデータ（Northwind） |
| **ストレージ** | S3 | データレイク（Delta Lake形式で保存） |
| **セキュリティ** | IAM Role | S3アクセス権限（Instance Profile経由） |
| | Secrets Manager | DB接続情報の安全な管理 |
| **監視/運用** | CloudWatch | ログ収集・メトリクス監視 |
| | SNS | ジョブ失敗時のメール/Slack通知 |
